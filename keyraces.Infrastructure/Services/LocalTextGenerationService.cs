using keyraces.Core.Interfaces;
using Microsoft.Extensions.Logging;

namespace keyraces.Infrastructure.Services
{
    public class LocalTextGenerationService : ITextGenerationService
    {
        private readonly ILogger<LocalTextGenerationService> _logger;
        private readonly Random _random = new Random();

        private readonly Dictionary<string, List<string>> _easyTexts;
        private readonly Dictionary<string, List<string>> _mediumTexts;
        private readonly Dictionary<string, List<string>> _hardTexts;

        public LocalTextGenerationService(ILogger<LocalTextGenerationService> logger)
        {
            _logger = logger;

            _easyTexts = InitializeEasyTexts();
            _mediumTexts = InitializeMediumTexts();
            _hardTexts = InitializeHardTexts();
        }

        public Task<string> GenerateTextAsync(string topic = "", string difficulty = "medium", int length = 300)
        {
            _logger.LogInformation($"Generating text locally. Topic: '{topic}', Difficulty: {difficulty}, Length: {length}");

            Dictionary<string, List<string>> textsDict;
            switch (difficulty.ToLower())
            {
                case "easy":
                    textsDict = _easyTexts;
                    break;
                case "hard":
                    textsDict = _hardTexts;
                    break;
                case "medium":
                default:
                    textsDict = _mediumTexts;
                    break;
            }

            string topicKey = "general";
            if (!string.IsNullOrEmpty(topic))
            {
                topicKey = FindClosestTopic(topic, textsDict.Keys);
            }

            List<string> availableTexts;
            if (textsDict.ContainsKey(topicKey))
            {
                availableTexts = textsDict[topicKey];
            }
            else if (textsDict.ContainsKey("general"))
            {
                availableTexts = textsDict["general"];
            }
            else
            {
                availableTexts = textsDict.Values.GetEnumerator().Current;
            }

            string selectedText = availableTexts[_random.Next(availableTexts.Count)];

            if (!string.IsNullOrEmpty(topic) && topicKey == "general")
            {
                selectedText = $"Тема этого текста - {topic}. " + selectedText;
            }

            if (selectedText.Length < length)
            {
                selectedText = ExtendText(selectedText, availableTexts, length);
            }
            else if (selectedText.Length > length)
            {
                selectedText = TrimText(selectedText, length);
            }

            _logger.LogInformation($"Generated text with {selectedText.Length} characters");
            return Task.FromResult(selectedText);
        }

        private string FindClosestTopic(string topic, IEnumerable<string> availableTopics)
        {
            topic = topic.ToLower();

            foreach (var availableTopic in availableTopics)
            {
                if (topic.Contains(availableTopic) || availableTopic.Contains(topic))
                {
                    return availableTopic;
                }
            }

            return "general";
        }

        private string ExtendText(string text, List<string> availableTexts, int targetLength)
        {
            while (text.Length < targetLength)
            {
                string additionalText = availableTexts[_random.Next(availableTexts.Count)];
                text += " " + additionalText;
            }

            return TrimText(text, targetLength);
        }

        private string TrimText(string text, int targetLength)
        {
            if (text.Length <= targetLength)
                return text;

            int lastSentenceEnd = text.LastIndexOf('.', targetLength - 1);
            if (lastSentenceEnd > targetLength / 2)
            {
                return text.Substring(0, lastSentenceEnd + 1);
            }

            int lastSpace = text.LastIndexOf(' ', targetLength - 1);
            if (lastSpace > 0)
            {
                return text.Substring(0, lastSpace) + ".";
            }

            return text.Substring(0, targetLength);
        }

        private Dictionary<string, List<string>> InitializeEasyTexts()
        {
            return new Dictionary<string, List<string>>
            {
                ["general"] = new List<string>
                {
                    "Быстрая коричневая лиса прыгает через ленивую собаку. Это предложение содержит все буквы алфавита. Оно часто используется для проверки клавиатур и шрифтов. Печатайте этот текст медленно и аккуратно, следя за каждой буквой. Практика делает совершенство.",

                    "Сегодня прекрасный день для прогулки в парке. Солнце светит ярко, и птицы поют на деревьях. Многие люди гуляют со своими собаками или просто наслаждаются хорошей погодой. Некоторые читают книги на скамейках, другие играют в спортивные игры на траве.",

                    "Кошки - популярные домашние животные во многих странах мира. Они независимы, чистоплотны и не требуют много внимания. Кошки могут спать до 16 часов в день. Они отличные охотники и могут видеть в темноте лучше, чем люди. Многие люди любят кошек за их мягкий мех и успокаивающее мурлыканье."
                },

                ["программирование"] = new List<string>
                {
                    "Язык HTML используется для создания веб-страниц. Он состоит из тегов, которые определяют структуру страницы. Каждый тег имеет открывающую и закрывающую части. Например, тег для абзаца выглядит так: <p>Это абзац</p>. HTML легко изучить, и он является основой для всех веб-сайтов.",

                    "Переменные в программировании используются для хранения данных. Они могут содержать числа, текст или другие типы информации. Чтобы создать переменную, нужно дать ей имя и присвоить значение. Например: x = 5 или name = 'Иван'. Переменные делают код более гибким и удобным."
                },

                ["спорт"] = new List<string>
                {
                    "Бег - один из самых простых и доступных видов спорта. Для него не нужно специальное оборудование, только удобная обувь. Бег укрепляет сердце, легкие и мышцы. Многие люди бегают по утрам, чтобы зарядиться энергией на весь день. Даже короткие пробежки могут значительно улучшить здоровье.",

                    "Футбол - самый популярный вид спорта в мире. В него играют две команды по одиннадцать игроков. Цель игры - забить мяч в ворота соперника. Игроки могут касаться мяча любой частью тела, кроме рук. Только вратарь может брать мяч руками в своей штрафной площади."
                }
            };
        }

        private Dictionary<string, List<string>> InitializeMediumTexts()
        {
            return new Dictionary<string, List<string>>
            {
                ["general"] = new List<string>
                {
                    "Программирование - это процесс создания набора инструкций, которые говорят компьютеру, как выполнить задачу. Программирование может быть выполнено с использованием различных языков программирования, таких как JavaScript, Python и C++. Каждый язык имеет свои сильные и слабые стороны и может быть более подходящим для определенных типов задач.",

                    "Интернет - глобальная система взаимосвязанных компьютерных сетей, которая использует стандартный набор протоколов для обслуживания миллиардов пользователей по всему миру. Он состоит из миллионов частных, публичных, академических, деловых и правительственных сетей, которые связаны между собой широким спектром электронных, беспроводных и оптических сетевых технологий.",

                    "Искусственный интеллект (ИИ) - это область компьютерной науки, которая подчеркивает создание интеллектуальных машин, которые работают и реагируют как люди. Некоторые из видов деятельности, которые компьютеры с искусственным интеллектом предназначены для выполнения, включают распознавание речи, обучение, планирование и решение проблем."
                },

                ["наука"] = new List<string>
                {
                    "Фотосинтез - это процесс, используемый растениями и некоторыми бактериями для преобразования световой энергии в химическую энергию. Этот химический процесс преобразует углекислый газ и воду в глюкозу и кислород. Фотосинтез является одним из самых важных биохимических процессов на Земле, так как почти все живые организмы зависят от него прямо или косвенно.",

                    "Периодическая таблица элементов - это табличное расположение химических элементов, организованное по атомному номеру, электронной конфигурации и повторяющимся химическим свойствам. Эта организация показывает периодические тенденции, такие как элементы с похожими свойствами в одном столбце. Таблица также делит элементы на блоки по орбиталям их валентных электронов."
                },

                ["история"] = new List<string>
                {
                    "Промышленная революция была периодом быстрой индустриализации и инноваций, который начался в Великобритании в конце 18 века. Этот период характеризовался переходом от ручного производства к машинному, развитием фабричной системы и ростом железных дорог. Промышленная революция привела к значительным социальным и экономическим изменениям, включая рост городов и среднего класса.",

                    "Древний Рим был цивилизацией, которая выросла из небольшого сельскохозяйственного сообщества, основанного на Итальянском полуострове в 9 веке до нашей эры, до огромной империи, простирающейся от Британии до Ближнего Востока и Африки. Римская империя была одной из самых могущественных экономических, культурных, политических и военных сил в мире своего времени."
                }
            };
        }

        private Dictionary<string, List<string>> InitializeHardTexts()
        {
            return new Dictionary<string, List<string>>
            {
                ["general"] = new List<string>
                {
                    "В квантовой механике принцип неопределенности Гейзенберга утверждает, что невозможно одновременно точно измерить положение и импульс частицы. Это фундаментальное ограничение, которое имеет глубокие последствия для нашего понимания физического мира. Оно показывает, что на квантовом уровне существует неустранимая неопределенность, которая не является результатом ограничений наших измерительных приборов.",

                    "Блокчейн - это распределенная база данных, которая поддерживает постоянно растущий список записей, называемых блоками. Каждый блок содержит временную метку и ссылку на предыдущий блок. Криптография обеспечивает, что пользователи могут редактировать только те части блокчейна, которыми они 'владеют', имея закрытые ключи, необходимые для записи в файл. Кроме того, криптография гарантирует, что все могут прозрачно видеть, что изменения были внесены в блокчейн.",

                    "Нейронные сети - это вычислительные системы, вдохновленные биологическими нейронными сетями, составляющими мозг животных. Такие системы учатся выполнять задачи, рассматривая примеры, обычно без программирования с конкретными правилами. Например, при распознавании изображений они могут научиться идентифицировать изображения, содержащие кошек, анализируя примеры изображений, которые были вручную помечены как 'кошка' или 'без кошки', и используя результаты для идентификации кошек в других изображениях."
                },

                ["философия"] = new List<string>
                {
                    "Экзистенциализм - это философское направление, подчеркивающее индивидуальное существование, свободу и выбор. Он утверждает, что люди определяют свой собственный смысл в жизни, и пытаются сделать рациональные решения, несмотря на существование в иррациональной вселенной. Основные понятия экзистенциализма включают абсурд, тревогу, отчуждение, свободу, ответственность и аутентичность.",

                    "Эпистемология, или теория познания, является ветвью философии, которая занимается природой и объемом знания, его предпосылками и основами, а также общей надежностью утверждений о знании. Она касается таких вопросов, как 'Что такое знание?', 'Как мы приобретаем знания?', 'Что люди знают?', 'Что значит знать?', и 'Почему мы знаем то, что знаем?'."
                },

                ["медицина"] = new List<string>
                {
                    "Иммунная система - это сложная сеть клеток, тканей и органов, которые работают вместе для защиты организма от инфекций. Ключевыми компонентами иммунной системы являются белые кровяные клетки, антитела, система комплемента, лимфатическая система, селезенка, тимус и костный мозг. Эти элементы работают вместе, чтобы защитить организм от болезнетворных микроорганизмов, таких как бактерии, вирусы, паразиты и грибки.",

                    "Нейропластичность относится к способности мозга изменять свою структуру и функции в ответ на опыт, обучение и травмы. Это фундаментальное свойство мозга, которое позволяет нейронам компенсировать травмы и болезни, а также адаптироваться к новым ситуациям или изменениям в окружающей среде. Нейропластичность играет важную роль в развитии мозга, обучении, памяти и восстановлении после повреждения мозга."
                }
            };
        }
    }
}